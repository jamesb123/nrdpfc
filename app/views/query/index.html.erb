<h1>Query</h1>

<% content_tag :div, :id => "query_form" do %>
<div style="width:400px; display:block; float:left;" />
  <h2>Tables</h2>
  <ul id='query_field_selector'>
    <% Exportables::ExportableModel.models.each do |model| 
      table_name = model.exportable_name
      # checked = @query.tables.include?(model_name)
      fields_ul_id = "#{table_name}_fields"
      table_checkbox_id = "query_tables_#{table_name}"
      %>
      <li>
        <%= link_to_function(table_name.titleize, "toggle_section('#{table_name}')") %>
        <ul id="<%= fields_ul_id %>" style="display: none">
            <li>
              <%= link_to_remote("- Add all -", :url => {:action => "add_field", :table => table_name}) %>
            </li>
          <% model.exportable_non_id_fields.each do |field| %>
            <li>
              <%= link_to_remote(field.titleize, :url => {:action => "add_field", :table => table_name, :field => field}) %>
            </li>
          <% end %>
        </ul>
      </li>    
      <script language='javascript'>
        // new ElementFader( '<%= table_checkbox_id %>', '<%= fields_ul_id %>', "=='<%= table_name %>'");
      </script>
    <% end %>
  </ul>
  
</div>
<div style="width:600px; display:block; float:left">
  <h2>Selected Fields</h2>
  <table id='selected_fields_entries_table'>
    <thead>
      <tr>
        <th></th>
        <th>Model Name</th>
        <th>Field Name</th>
        <th>Sort</th>
        <th>Filter</th>
      </tr>
    </thead>
    <tbody id="selected_fields_entries">
    </tbody>
  </table>
</div>
<br clear='both' />
  <% indicated_div "query_submit_button" do %>
    <%= content_tag :button, "Preview", :onclick => 
          remote_function(
            :url => {:action => "show" }, 
            :submit => "query_form", 
            :indicate => "query_submit_button", 
            :update => "results_output", 
            :html => {:id => "query_form"}) %>
    <%= content_tag :button, "Download (csv)", :onclick => 
          remote_function(
            :url => {:action => "download_csv"}, 
            :submit => "query_form", 
            :indicate => "query_submit_button") %>
  <% end %>
<% end %>

<script language='javascript'>
  function go_select_all(this_cb)
  {
    $(this_cb).up('ul').getElementsBySelector('input[type=checkbox]').each(function(cb) { cb.checked = this_cb.checked });    
  }
  
  function toggle_section(table_name)
  {
    var fields_ul_id = table_name + "_fields";
    
    $$("ul#query_field_selector > li > ul").each(function(ul) {
      if (ul.id == fields_ul_id) { new Effect.BlindDown(ul, { duration: 0.5 }); return false; }
      if (ul.visible()) new Effect.BlindUp(ul);
    });
  }

 Sorter = Class.create();
 Sorter.prototype = {
   initialize: function(table, column_classes) {
     this.table = $(table);
     this.column_classes = column_classes
   },
   get_rows: function() {
     return this.table.getElementsBySelector('tr');
   },    
   do_sort: function() {
     if(this.get_rows().length <= 1) return true;

     var result;
     var rows = this.get_rows();
     do {
       var sorted = true;
       for (x=0; x<= rows.length - 2; x++) {

         var row1 = rows[x]
         var row2 = rows[x+1];
         if (!row2) continue;
         result = this.compare_rows(row1, row2);
         switch(result) {
           case 0:
             rows.splice(x+1, 1);
             row2.remove();
             sorted = false;
             break;
           case 1:
             rows[x] = row2;
             rows[x+1] = row1;
             sorted = false;
             break;
         }
       }
     } while (! sorted);

     that = this;
     rows.each(function(r) { r.remove()});
     rows.each(function(r) { that.table.appendChild(r)});
   },
   compare_rows: function(r1, r2) {
     var result = 0;
     this.column_classes.each(function(c) {
       v1 = r1.down("." + c).innerHTML;
       v2 = r2.down("." + c).innerHTML;
       if (v1 != v2)
       {
         if (v1 > v2) 
           { result = 1; throw $break; }
         else
           { result = -1; throw $break; }        
         end
       }
     });
     return result;
   }
 }

</script>

<div id="results_output">
  
</div>